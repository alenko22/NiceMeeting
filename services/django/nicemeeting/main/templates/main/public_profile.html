{% extends 'main/base.html' %}
{% load static %}

{% block title %}
Публичный профиль
{% endblock %}

{% block content %}
<div class="public-profile">
    <!-- Шапка профиля -->
    <section class="public-profile__header">
        <div class="container">
            <div class="public-profile__header-content">
                <div class="public-profile__avatar-wrapper">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="Аватар пользователя" class="public-profile__avatar">
                    {% else %}
                        <img src="{% static 'images/default-avatar.png' %}" alt="Аватар пользователя" class="public-profile__avatar">
                    {% endif %}
                </div>
                <div class="public-profile__info">
                    <h1 class="public-profile__name">{{ user.get_full_name|default:user.username }}</h1>
                    {% if user.bio %}
                        <p class="public-profile__bio">{{ user.bio }}</p>
                    {% endif %}
                    <div class="public-profile__stats">
                        <div class="public-profile__stat-item">
                            <span class="public-profile__stat-value">{{ user.posts.count|default:0 }}</span>
                            <span class="public-profile__stat-label">Постов</span>
                        </div>
                        <div class="public-profile__stat-item">
                            <span class="public-profile__stat-value">{{ user.followers.count|default:0 }}</span>
                            <span class="public-profile__stat-label">Подписчиков</span>
                        </div>
                        <div class="public-profile__stat-item">
                            <span class="public-profile__stat-value">{{ user.following.count|default:0 }}</span>
                            <span class="public-profile__stat-label">Подписок</span>
                        </div>
                    </div>
                    <div class="public-profile__actions">
                        {% if request.user.is_authenticated and request.user != user %}
                            <button class="btn btn-primary public-profile__follow-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Подписаться
                            </button>
                            <button class="btn btn-outline public-profile__message-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                Написать
                            </button>
                            <button class="btn btn-outline public-profile__schedule-meeting-btn" data-user-id="{{ user.id }}" data-username="{{ user.get_full_name|default:user.username }}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                Назначить встречу
                            </button>
                        {% elif request.user.is_authenticated and request.user == user %}
                            <a href="{% url 'create_post' %}" class="btn btn-primary public-profile__add-post-btn href">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Добавить пост
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Интересы пользователя -->
    <section class="public-profile__interests">
        <div class="container">
            <h2 class="public-profile__section-title">Интересы</h2>
            <div class="public-profile__interests-list">
                {% for interest in user.interests.all %}
                    <span class="public-profile__interest">{{ interest.name }}</span>
                {% empty %}
                    <p class="public-profile__no-interests">Интересы не указаны</p>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Посты пользователя -->
    <section class="public-profile__posts">
        <div class="container">
            <div class="public-profile__posts-header">
                <h2 class="public-profile__section-title">Посты</h2>
                <div class="public-profile__posts-filter">
                    <button class="btn btn-outline public-profile__filter-btn public-profile__filter-btn--active">Все</button>
                    <button class="btn btn-outline public-profile__filter-btn">Фото</button>
                    <button class="btn btn-outline public-profile__filter-btn">Текст</button>
                </div>
            </div>

            <div class="public-profile__posts-grid">
                {% for post in posts|slice:":3" %}
                <article class="public-profile__post" data-post-id="{{ post.id }}">
                    <div class="public-profile__post-header">
                        <div class="public-profile__post-meta">
                            <span class="public-profile__post-date">{{ post.date_posted|timesince }} назад</span>
                            {% if request.user.is_authenticated and request.user == user %}
                                    <button
                                        class="btn btn-outline public-profile__post-delete-btn"
                                        title="Удалить пост"
                                        data-delete-url="{% url 'delete_post' post.id %}"
                                    >
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% if post.image %}
                        <div class="public-profile__post-image">
                            <img src="{{ post.image.url }}" alt="{{ post.text }}" class="public-profile__post-img">
                        </div>
                    {% endif %}
                    <div class="public-profile__post-content">
                        <p class="public-profile__post-text">
                            {{ post.text }}
                        </p>

                    </div>
                    <div class="public-profile__post-footer">
                        <a href="{% url 'commentaries' post.id %}" class="btn btn-outline public-profile__post-comment-btn href">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            {{ post.comments_count|default:0 }}
                        </a>
                    </div>
                </article>
                {% empty %}
                <p class="public-profile__no-posts">Пользователь ещё не добавил ни одного поста</p>
                {% endfor %}
            </div>

            <!-- Пагинация -->
            <div class="public-profile__pagination">
                <button class="btn btn-outline public-profile__pagination-btn public-profile__pagination-btn--prev">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Предыдущие
                </button>
                <span class="public-profile__pagination-info">Страница 1 из 6</span>
                <button class="btn btn-outline public-profile__pagination-btn public-profile__pagination-btn--next">
                    Следующие
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </section>
</div>

<!-- Модальное окно назначения встречи -->
<!-- Модальное окно назначения встречи -->
{% if request.user.is_authenticated and request.user != user %}
<div class="modal modal--schedule-meeting" id="scheduleMeetingModal">
    <div class="modal__backdrop"></div>
    <div class="modal__dialog">
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Назначить встречу с {{ user.get_full_name|default:user.username }}</h3>
                <button class="modal__close-btn" id="closeScheduleMeetingModal">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal__body">
                <form id="scheduleMeetingForm" class="schedule-meeting-form" data-action-url="{% url 'create_meeting' %}">
                    {% csrf_token %}
                    <input type="hidden" name="user2_id" value="{{ user.id }}">

                    <!-- Выбор типа встречи -->
                    <div class="form-field">
                        <label class="form-field__label">Тип встречи</label>
                        <div class="schedule-meeting-form__type-selector">
                            <button type="button" class="btn btn-outline schedule-meeting-form__type-btn schedule-meeting-form__type-btn--active" data-type="event">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                На мероприятии
                            </button>
                            <button type="button" class="btn btn-outline schedule-meeting-form__type-btn" data-type="place">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                В другом месте
                            </button>
                        </div>
                    </div>

                    <!-- Выбор мероприятия -->
                    <div class="schedule-meeting-form__section schedule-meeting-form__section--event">
                        <div class="form-field">
                            <label class="form-field__label">Выберите мероприятие</label>
                            <select name="event" class="form-field__select schedule-meeting-form__event-select" required>
                                <option value="">Выберите мероприятие...</option>
                                {% for event in events %}
                                    {% if event.date_end > now %}
                                    <option value="{{ event.id }}" data-place="{{ event.place }}">
                                        {{ event.title }} — {{ event.date_begin|date:"d E Y, H:i" }}
                                        {% if event.place %}({{ event.place }}){% endif %}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <span class="form-field__error schedule-meeting-form__event-error"></span>
                        </div>
                    </div>

                    <!-- Выбор места -->
                    <div class="schedule-meeting-form__section schedule-meeting-form__section--place" style="display: none;">
                        <div class="form-field">
                            <label class="form-field__label">Место встречи</label>
                            <input type="text" name="place" class="form-field__input schedule-meeting-form__place-input" placeholder="Кофейня, парк, адрес..." maxlength="255">
                            <span class="form-field__error schedule-meeting-form__place-error"></span>
                        </div>
                    </div>

                    <!-- Дата и время -->
                    <div class="form-field">
                        <label class="form-field__label">Дата и время встречи</label>
                        <input type="datetime-local" name="datetime" class="form-field__input schedule-meeting-form__datetime-input" required>
                        <span class="form-field__error schedule-meeting-form__datetime-error"></span>
                    </div>

                    <!-- Информация об участниках -->
                    <div class="schedule-meeting-form__info">
                        <p class="schedule-meeting-form__info-text">
                            <strong>Участники:</strong>
                            <span class="schedule-meeting-form__participant">{{ request.user.get_full_name|default:request.user.username }}</span>
                            и
                            <span class="schedule-meeting-form__participant">{{ user.get_full_name|default:user.username }}</span>
                        </p>
                        <p class="schedule-meeting-form__info-note">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="vertical-align: -3px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12" y2="8"></line>
                            </svg>
                            Вы можете добавить других участников позже через страницу встречи
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn-secondary" id="closeScheduleMeetingModalBtn">Отмена</button>
                <button type="submit" form="scheduleMeetingForm" class="btn btn-primary schedule-meeting-form__submit-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    Назначить встречу
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/public_profile.js' %}"></script>
{% endblock %}