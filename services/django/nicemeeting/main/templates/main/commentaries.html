{% extends 'main/base.html' %}
{% load static %}

{% block title %}
Комментарии
{% endblock %}

{% block content %}
<div class="page-content">
    <div class="container">
        <div class="post-comments">
            <!-- Заголовок -->
            <h1 class="post-comments__title">
                Комментарии
            </h1>

            <!-- Карточка поста -->
            <div class="post-comments__post-card public-profile__post">
                <div class="post-comments__post-header public-profile__post-header">
                    <div class="post-comments__post-meta public-profile__post-meta">
                        <div class="post-comments__post-author">
                            <strong>{{ post.author }}</strong>
                        </div>
                        <div class="post-comments__post-date public-profile__post-date">
                            {{ post.date_posted|timesince }} назад
                        </div>
                    </div>
                </div>
                {% if post.image %}
                <div class="post-comments__post-image public-profile__post-image">
                    <img src="{{ post.image.url }}" alt="Пост" class="post-comments__post-img public-profile__post-img">
                </div>
                {% endif %}
                <div class="post-comments__post-content public-profile__post-content">
                    <p class="post-comments__post-text public-profile__post-text">
                        {{ post.text }}
                    </p>
                </div>
                <div class="post-comments__post-footer public-profile__post-footer">
                    <button class="btn post-comments__post-comment-btn public-profile__post-comment-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                        </svg>
                        <span>{{ post.comments.count|default:0 }} комментариев</span>
                    </button>
                </div>
            </div>

            <div class="post-comments__form-section" id="main-comment-form">
                <h2 class="post-comments__form-title" id="form-title">
                    Оставить комментарий
                </h2>
                <form class="post-comments__form" method="post" action="{% url 'add_comment' %}" id="comment-form">
                    {% csrf_token %}

                    <input type="hidden" name="post" value="{{ post.id }}">
                    <input type="hidden" name="parent_comment" id="id_parent_comment" value="">

                    <div class="form-field">
                        <label for="id_text" class="form-field__label visually-hidden">
                            Комментарий
                        </label>
                        <textarea
                            id="id_text"
                            name="text"
                            class="form-field__textarea"
                            placeholder="Напишите ваш комментарий..."
                            required
                        ></textarea>
                    </div>
                    <div class="post-comments__form-actions">
                        <button type="submit" class="btn btn-primary post-comments__submit-btn" id="submit-btn">
                            Опубликовать
                        </button>
                        <button type="button" class="btn btn-outline post-comments__cancel-btn" id="cancel-btn" style="display: none;">
                            Отмена
                        </button>
                    </div>
                </form>
            </div>

            <!-- Список комментариев -->
            <div class="post-comments__comments-section">
                <h2 class="post-comments__comments-title">
                    Комментарии ({{ post.comments.count|default:0 }})
                </h2>

                <div class="post-comments__list">
                    {% for comment in comments %}
                    <div class="post-comments__comment message {% if comment.author == request.user %}message--sent{% else %}message--received{% endif %}">
                        <div class="post-comments__comment-avatar message__avatar">
                            <div class="post-comments__comment-avatar-img message__avatar-img" style="background: linear-gradient(135deg, #f29fb0, #f7c7d4);">
                                <span class="post-comments__comment-avatar-letter message__avatar-letter">{{ comment.author.username|first|upper }}</span>
                            </div>
                        </div>
                        <div class="post-comments__comment-content message__content">
                            <div class="post-comments__comment-header">
                                <strong class="post-comments__comment-author">
                                    {{ comment.author.username }}
                                    {% if comment.author == post.author %}
                                    <span class="post-comments__comment-author-badge">(автор)</span>
                                    {% endif %}
                                </strong>
                                <span class="post-comments__comment-date">{{ comment.created_at|date:"d F Y, H:i" }}</span>
                            </div>
                            <p class="post-comments__comment-text message__text">
                                {{ comment.text }}
                            </p>
                            <div class="post-comments__comment-actions">
                                <button class="btn btn-outline post-comments__comment-like">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                    <span>{{ comment.likes_count }}</span>
                                </button>
                                <button
                                    class="btn btn-outline post-comments__comment-reply"
                                    data-comment-id="{{ comment.id }}"
                                    data-author="{{ comment.author.username }}"
                                >
                                    Ответить
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ответы на комментарий -->
                    {% for reply in comment.replies.all %}
                    <div class="post-comments__comment post-comments__comment--reply message {% if reply.author == request.user %}message--sent{% else %}message--received{% endif %}">
                        <div class="post-comments__comment-avatar message__avatar">
                            <div class="post-comments__comment-avatar-img message__avatar-img" style="background: linear-gradient(135deg, #f29fb0, #f7c7d4);">
                                <span class="post-comments__comment-avatar-letter message__avatar-letter">{{ reply.author.username|first|upper }}</span>
                            </div>
                        </div>
                        <div class="post-comments__comment-content message__content">
                            <div class="post-comments__comment-header">
                                <strong class="post-comments__comment-author">
                                    {{ reply.author.username }}
                                    {% if reply.author == post.author %}
                                    <span class="post-comments__comment-author-badge">(автор)</span>
                                    {% endif %}
                                </strong>
                                <span class="post-comments__comment-date">{{ reply.created_at|date:"d F Y, H:i" }}</span>
                            </div>
                            <p class="post-comments__comment-text message__text">
                                {{ reply.text }}
                            </p>
                            <div class="post-comments__comment-actions">
                                <button class="btn btn-outline post-comments__comment-like">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                    <span>{{ reply.likes_count }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% empty %}
                    <p class="post-comments__no-comments">Пока нет комментариев. Будьте первым!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/commentaries.js' %}"></script>
{% endblock %}